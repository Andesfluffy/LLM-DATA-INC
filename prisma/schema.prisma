generator client {
  provider = "prisma-client-js"
  engineType = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  // Optional org relation for org-scoped data sources and logs
  orgId         String?
  org           Org?      @relation(fields: [orgId], references: [id])
  dataSources   DataSource[]
  audits        QueryAudit[]
  auditLogs     AuditLog[]
  glossaryTerms GlossaryTerm[]
  savedQueries  SavedQuery[]
  dashboards    Dashboard[]
  onboardingComplete Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model DataSource {
  id        String   @id @default(cuid())
  // Legacy fields used by existing UI
  name      String

  // New org-scoped fields per spec
  orgId     String?
  org       Org?     @relation(fields: [orgId], references: [id])
  type      String   @default("postgres")
  host      String?
  port      Int?
  database  String?
  user      String?

  passwordCiphertext String?
  passwordIv         String?
  passwordTag        String?
  urlCiphertext      String?
  urlIv              String?
  urlTag             String?

  // Legacy owner linkage (optional now to avoid breaking changes)
  ownerId   String?
  owner     User?    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  metadata  Json?

    queryAudits QueryAudit[]
    tableScopes DataSourceTableScope[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

  @@index([orgId])
}

model DataSourceTableScope {
  id           String     @id @default(cuid())
  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  tableName    String
  createdAt    DateTime   @default(now())

  @@unique([dataSourceId, tableName])
  @@index([dataSourceId])
}

model QueryAudit {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataSourceId  String?
  dataSource    DataSource? @relation(fields: [dataSourceId], references: [id])
  nlQuery       String?
  generatedSql  String?
  executedSql   String?
  status        String
  error         String?
  durationMs    Int?
  rowCount      Int?
  createdAt     DateTime @default(now())
}

// New models to satisfy requested API behavior
model Org {
  id          String       @id @default(cuid())
  name        String
  users       User[]
  datasources DataSource[]
  monitorSchedule OrgMonitorSchedule?
  monitorRuns     MonitorRun[]
  kpiSnapshots    KpiSnapshot[]
  auditLogs   AuditLog[]
  glossaryTerms GlossaryTerm[]
  savedQueries  SavedQuery[]
  dashboards    Dashboard[]
  weeklyBusinessReports WeeklyBusinessReport[]
  reportDeliveryLogs    ReportDeliveryLog[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model OrgMonitorSchedule {
  id                    String   @id @default(cuid())
  orgId                 String   @unique
  org                   Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  weeklyReportDay       Int      @default(1)
  weeklyReportHour      Int      @default(9)
  weeklyReportMinute    Int      @default(0)
  timezone              String   @default("UTC")
  revenueDropThreshold  Float    @default(0.15)
  expenseSpikeThreshold Float    @default(0.2)
  refundSpikeThreshold  Float    @default(0.2)
  marginDropThreshold   Float    @default(0.1)
  enabled               Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model MonitorRun {
  id            String   @id @default(cuid())
  orgId          String
  org            Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  dataSourceId   String
  dataSource     DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  status         String
  trigger        String   @default("cron")
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  error          String?
  retryCount     Int      @default(0)
  schemaRefreshed Boolean @default(false)
  windowStart    DateTime
  windowEnd      DateTime
  findings       MonitorFinding[]
  snapshots      KpiSnapshot[]

  @@index([orgId, startedAt])
  @@index([dataSourceId, startedAt])
}

model MonitorFinding {
  id            String   @id @default(cuid())
  runId         String
  run           MonitorRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  kind          String
  severity      String
  title         String
  description   String?
  currentValue  Float?
  previousValue Float?
  changeRatio   Float?
  createdAt     DateTime @default(now())

  @@index([runId])
  @@index([kind])
}

model KpiSnapshot {
  id            String   @id @default(cuid())
  orgId         String
  org           Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  dataSourceId  String
  dataSource    DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  runId         String?
  run           MonitorRun? @relation(fields: [runId], references: [id], onDelete: SetNull)
  windowStart   DateTime
  windowEnd     DateTime
  metrics       Json
  createdAt     DateTime @default(now())

  @@index([orgId, dataSourceId, windowStart])
}

model AuditLog {
  id         String   @id @default(cuid())
  orgId      String
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  question   String
  sql        String?
  durationMs Int?
  rowCount   Int?
  createdAt  DateTime @default(now())

  @@index([userId])
}

model GlossaryTerm {
  id          String   @id @default(cuid())
  orgId       String
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  term        String
  definition  String
  description String?
  category    String   @default("metric")
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orgId, term])
  @@index([orgId])
}

model SavedQuery {
  id         String   @id @default(cuid())
  orgId      String
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String?
  question   String
  sql        String?
  isFavorite Boolean  @default(false)
  isShared   Boolean  @default(false)
  tags       String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  widgets       DashboardWidget[]

  @@index([orgId])
  @@index([userId])
  @@index([orgId, isShared])
}

model Dashboard {
  id        String            @id @default(cuid())
  orgId     String
  org       Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String            @default("My Dashboard")
  widgets   DashboardWidget[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([orgId])
  @@index([userId])
}

model DashboardWidget {
  id           String     @id @default(cuid())
  dashboardId  String
  dashboard    Dashboard  @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  savedQueryId String
  savedQuery   SavedQuery @relation(fields: [savedQueryId], references: [id], onDelete: Cascade)
  position     Int        @default(0)
  displayType  String     @default("table")
  createdAt    DateTime   @default(now())

  @@index([dashboardId])
}

model WeeklyBusinessReport {
  id              String          @id @default(cuid())
  orgId           String
  org             Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  periodStart     DateTime
  periodEnd       DateTime
  status          String          @default("generated")
  healthScore     Int?
  summary         String?
  markdownContent String
  jsonContent     Json
  sections        ReportSection[]
  deliveries      ReportDeliveryLog[]
  generatedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([orgId, periodStart, periodEnd])
  @@unique([orgId, periodStart, periodEnd])
}

model ReportSection {
  id         String               @id @default(cuid())
  reportId   String
  report     WeeklyBusinessReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  key        String
  title      String
  markdown   String
  jsonData   Json
  sortOrder  Int                  @default(0)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@index([reportId, sortOrder])
}

model ReportDeliveryLog {
  id         String               @id @default(cuid())
  orgId      String
  org        Org                  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  reportId   String
  report     WeeklyBusinessReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  channel    String               @default("in_app")
  status     String               @default("delivered")
  deliveredTo String?
  metadata   Json?
  createdAt  DateTime             @default(now())

  @@index([orgId, createdAt])
  @@index([reportId])
}
