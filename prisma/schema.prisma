generator client {
  provider = "prisma-client-js"
  engineType = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  memberships   OrgMembership[]
  secretRotations SecretRotationEvent[]
  allowlistEntries IpAllowlistEntry[]
  alertConfigsUpdated AlertConfig[]
  // Optional org relation for org-scoped data sources and logs
  orgId         String?
  org           Org?      @relation(fields: [orgId], references: [id])
  dataSources   DataSource[]
  audits        QueryAudit[]
  auditLogs     AuditLog[]
  glossaryTerms GlossaryTerm[]
  savedQueries  SavedQuery[]
  dashboards    Dashboard[]
  onboardingComplete Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  userAgent    String?
  ipAddress    String?
  deviceName   String?
  lastSeenAt   DateTime?
  revokedAt    DateTime?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum OrgRole {
  owner
  admin
  analyst
  viewer
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model DataSource {
  id        String   @id @default(cuid())
  // Legacy fields used by existing UI
  name      String

  // New org-scoped fields per spec
  orgId     String?
  org       Org?     @relation(fields: [orgId], references: [id])
  type      String   @default("postgres")
  host      String?
  port      Int?
  database  String?
  user      String?

  passwordCiphertext String?
  passwordIv         String?
  passwordTag        String?
  urlCiphertext      String?
  urlIv              String?
  urlTag             String?

  // Legacy owner linkage (optional now to avoid breaking changes)
  ownerId   String?
  owner     User?    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  metadata  Json?

    queryAudits QueryAudit[]
    tableScopes DataSourceTableScope[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

  @@index([orgId])
}

model DataSourceTableScope {
  id           String     @id @default(cuid())
  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  tableName    String
  createdAt    DateTime   @default(now())

  @@unique([dataSourceId, tableName])
  @@index([dataSourceId])
}

model QueryAudit {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataSourceId  String?
  dataSource    DataSource? @relation(fields: [dataSourceId], references: [id])
  nlQuery       String?
  generatedSql  String?
  executedSql   String?
  status        String
  error         String?
  durationMs    Int?
  rowCount      Int?
  createdAt     DateTime @default(now())
}

// New models to satisfy requested API behavior
model Org {
  id          String       @id @default(cuid())
  name        String
  subscription Subscription?
  users       User[]
  memberships OrgMembership[]
  datasources DataSource[]
  monitorSchedule OrgMonitorSchedule?
  monitorRuns     MonitorRun[]
  kpiSnapshots    KpiSnapshot[]
  auditLogs   AuditLog[]
  secretRotations SecretRotationEvent[]
  ipAllowlist IpAllowlistEntry[]
  alertConfigs AlertConfig[]
  glossaryTerms GlossaryTerm[]
  savedQueries  SavedQuery[]
  dashboards    Dashboard[]
  weeklyBusinessReports WeeklyBusinessReport[]
  reportDeliveryLogs    ReportDeliveryLog[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

enum BillingPlan {
  FREE
  PRO
  GROWTH
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
}

model Subscription {
  id        String             @id @default(cuid())
  orgId     String             @unique
  org       Org                @relation(fields: [orgId], references: [id], onDelete: Cascade)
  plan      BillingPlan        @default(FREE)
  status    SubscriptionStatus @default(ACTIVE)
  seats     Int                @default(1)
  limits    Json?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([plan])
  @@index([status])
}

model AuditLog {
  id         String   @id @default(cuid())
  orgId      String
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String   @default("query.executed")
  question   String?
  sql        String?
  targetType String?
  targetId   String?
  metadata   Json?
  durationMs Int?
  rowCount   Int?
  createdAt  DateTime @default(now())

  @@index([userId])
}

model OrgMembership {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  role      OrgRole  @default(viewer)
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, userId])
  @@index([userId])
}

model SecretRotationEvent {
  id          String   @id @default(cuid())
  orgId       String
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  datasourceId String?
  status      String   @default("completed")
  notes       String?
  createdAt   DateTime @default(now())

  @@index([orgId])
}

model IpAllowlistEntry {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  cidr      String
  label     String?
  enabled   Boolean  @default(true)
  createdById String?
  createdBy User?    @relation(fields: [createdById], references: [id])
  createdAt DateTime @default(now())

  @@index([orgId, enabled])
}

model AlertConfig {
  id              String   @id @default(cuid())
  orgId           String
  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name            String
  condition       String
  destination     String
  enabled         Boolean  @default(true)
  updatedById     String?
  updatedBy       User?    @relation(fields: [updatedById], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
}

model GlossaryTerm {
  id          String   @id @default(cuid())
  orgId       String
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  term        String
  definition  String
  description String?
  category    String   @default("metric")
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orgId, term])
  @@index([orgId])
}

model SavedQuery {
  id         String   @id @default(cuid())
  orgId      String
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String?
  question   String
  sql        String?
  isFavorite Boolean  @default(false)
  isShared   Boolean  @default(false)
  tags       String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  widgets       DashboardWidget[]

  @@index([orgId])
  @@index([userId])
  @@index([orgId, isShared])
}

model Dashboard {
  id        String            @id @default(cuid())
  orgId     String
  org       Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String            @default("My Dashboard")
  widgets   DashboardWidget[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([orgId])
  @@index([userId])
}

model DashboardWidget {
  id           String     @id @default(cuid())
  dashboardId  String
  dashboard    Dashboard  @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  savedQueryId String
  savedQuery   SavedQuery @relation(fields: [savedQueryId], references: [id], onDelete: Cascade)
  position     Int        @default(0)
  displayType  String     @default("table")
  createdAt    DateTime   @default(now())

  @@index([dashboardId])
}

model WeeklyBusinessReport {
  id              String          @id @default(cuid())
  orgId           String
  org             Org             @relation(fields: [orgId], references: [id], onDelete: Cascade)
  periodStart     DateTime
  periodEnd       DateTime
  status          String          @default("generated")
  healthScore     Int?
  summary         String?
  markdownContent String
  jsonContent     Json
  sections        ReportSection[]
  deliveries      ReportDeliveryLog[]
  generatedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([orgId, periodStart, periodEnd])
  @@unique([orgId, periodStart, periodEnd])
}

model ReportSection {
  id         String               @id @default(cuid())
  reportId   String
  report     WeeklyBusinessReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  key        String
  title      String
  markdown   String
  jsonData   Json
  sortOrder  Int                  @default(0)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@index([reportId, sortOrder])
}

model ReportDeliveryLog {
  id         String               @id @default(cuid())
  orgId      String
  org        Org                  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  reportId   String
  report     WeeklyBusinessReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  channel    String               @default("in_app")
  status     String               @default("delivered")
  deliveredTo String?
  metadata   Json?
  createdAt  DateTime             @default(now())

  @@index([orgId, createdAt])
  @@index([reportId])
}
