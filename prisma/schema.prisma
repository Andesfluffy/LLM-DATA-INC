generator client {
  provider = "prisma-client-js"
  engineType = "binary"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  memberships   OrgMembership[]
  secretRotations SecretRotationEvent[]
  allowlistEntries IpAllowlistEntry[]
  alertConfigsUpdated AlertConfig[]
  // Optional org relation for org-scoped data sources and logs
  orgId         String?
  org           Org?      @relation(fields: [orgId], references: [id])
  dataSources   DataSource[]
  audits        QueryAudit[]
  auditLogs     AuditLog[]
  glossaryTerms GlossaryTerm[]
  savedQueries  SavedQuery[]
  dashboards    Dashboard[]
  onboardingComplete Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  userAgent    String?
  ipAddress    String?
  deviceName   String?
  lastSeenAt   DateTime?
  revokedAt    DateTime?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum OrgRole {
  owner
  admin
  analyst
  viewer
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model DataSource {
  id        String   @id @default(cuid())
  // Legacy fields used by existing UI
  name      String

  // New org-scoped fields per spec
  orgId     String?
  org       Org?     @relation(fields: [orgId], references: [id])
  type      String   @default("postgres")
  host      String?
  port      Int?
  database  String?
  user      String?

  passwordCiphertext String?
  passwordIv         String?
  passwordTag        String?
  urlCiphertext      String?
  urlIv              String?
  urlTag             String?

  // Legacy owner linkage (optional now to avoid breaking changes)
  ownerId   String?
  owner     User?    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  metadata  Json?

    queryAudits QueryAudit[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

  @@index([orgId])
}

model QueryAudit {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataSourceId  String?
  dataSource    DataSource? @relation(fields: [dataSourceId], references: [id])
  nlQuery       String?
  generatedSql  String?
  executedSql   String?
  status        String
  error         String?
  durationMs    Int?
  rowCount      Int?
  createdAt     DateTime @default(now())
}

// New models to satisfy requested API behavior
model Org {
  id          String       @id @default(cuid())
  name        String
  users       User[]
  memberships OrgMembership[]
  datasources DataSource[]
  auditLogs   AuditLog[]
  secretRotations SecretRotationEvent[]
  ipAllowlist IpAllowlistEntry[]
  alertConfigs AlertConfig[]
  glossaryTerms GlossaryTerm[]
  savedQueries  SavedQuery[]
  dashboards    Dashboard[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  orgId      String
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String   @default("query.executed")
  question   String?
  sql        String?
  targetType String?
  targetId   String?
  metadata   Json?
  durationMs Int?
  rowCount   Int?
  createdAt  DateTime @default(now())

  @@index([userId])
}

model OrgMembership {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  role      OrgRole  @default(viewer)
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, userId])
  @@index([userId])
}

model SecretRotationEvent {
  id          String   @id @default(cuid())
  orgId       String
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  datasourceId String?
  status      String   @default("completed")
  notes       String?
  createdAt   DateTime @default(now())

  @@index([orgId])
}

model IpAllowlistEntry {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  cidr      String
  label     String?
  enabled   Boolean  @default(true)
  createdById String?
  createdBy User?    @relation(fields: [createdById], references: [id])
  createdAt DateTime @default(now())

  @@index([orgId, enabled])
}

model AlertConfig {
  id              String   @id @default(cuid())
  orgId           String
  org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  name            String
  condition       String
  destination     String
  enabled         Boolean  @default(true)
  updatedById     String?
  updatedBy       User?    @relation(fields: [updatedById], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
}

model GlossaryTerm {
  id          String   @id @default(cuid())
  orgId       String
  org         Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  term        String
  definition  String
  description String?
  category    String   @default("metric")
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orgId, term])
  @@index([orgId])
}

model SavedQuery {
  id         String   @id @default(cuid())
  orgId      String
  org        Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String?
  question   String
  sql        String?
  isFavorite Boolean  @default(false)
  isShared   Boolean  @default(false)
  tags       String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  widgets       DashboardWidget[]

  @@index([orgId])
  @@index([userId])
  @@index([orgId, isShared])
}

model Dashboard {
  id        String            @id @default(cuid())
  orgId     String
  org       Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String            @default("My Dashboard")
  widgets   DashboardWidget[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([orgId])
  @@index([userId])
}

model DashboardWidget {
  id           String     @id @default(cuid())
  dashboardId  String
  dashboard    Dashboard  @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  savedQueryId String
  savedQuery   SavedQuery @relation(fields: [savedQueryId], references: [id], onDelete: Cascade)
  position     Int        @default(0)
  displayType  String     @default("table")
  createdAt    DateTime   @default(now())

  @@index([dashboardId])
}
